name: Register Key System

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  register-key:
    if: contains(github.event.issue.title, 'REGISTER_KEY')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Parse HWID and Generate Key
        id: keygen
        shell: bash
        run: |
          # Extract HWID from Issue Body (Assuming format: HWID: <value>)
          BODY="${{ github.event.issue.body }}"
          HWID=$(echo "$BODY" | grep "HWID:" | cut -d' ' -f2 | tr -d '\r')
          
          if [ -z "$HWID" ]; then
            echo "No HWID found"
            exit 1
          fi

          echo "HWID Detected: $HWID"
          
          # Generate Key (Deterministic Hash - Matches Client JS DJB2)
          KEY=$(node -e '
            const str = process.argv[1] + "WINDUI_SECRET_SALT_2025";
            let hash = 5381;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i);
            }
            console.log("ANHUB_" + Math.abs(hash).toString(16).toUpperCase().substring(0, 12));
          ' "$HWID")
          
          echo "Generated Key: $KEY"
          
          # Save to Output for next steps
          echo "generated_key=$KEY" >> $GITHUB_OUTPUT
          echo "hwid=$HWID" >> $GITHUB_OUTPUT
          
          # Append to keys.txt
          # Format: HWID KEY
          echo "$HWID $KEY" >> docs/keys.txt

      - name: Commit and Push Changes
        run: |
          git config --global user.name "Key System Bot"
          git config --global user.email "bot@noreply.github.com"
          
          git add docs/keys.txt
          git commit -m "Register Key for $HWID" || echo "No changes to commit"
          git push

      - name: Reply to User and Close Issue
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            âœ… **Success! Key Registered.**
            
            **HWID:** `${{ steps.keygen.outputs.hwid }}`
            **Key:** `${{ steps.keygen.outputs.generated_key }}`
            
            Your key has been added to the database. You can now use the script.
            *(This issue will be closed automatically)*
            
      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
